import React, { useEffect, useState } from "react";
import api from "../api";

function Reviewer() {
  const [exercises, setExercises] = useState([]);
  const [message, setMessage] = useState("");
  const [showForm, setShowForm] = useState(false);
  const [editingExercise, setEditingExercise] = useState(null);

  const [newExercise, setNewExercise] = useState({
    question: "",
    options: [],
    correct_option: null,
    correct_answer: "",
    type: "fill_blank",
    difficulty: "easy",
  });

  useEffect(() => {
    const fetchExercises = async () => {
      try {
        const response = await api.get("/reviewer/exercises");
        const validExercises = response.data.exercises.filter(
          (exercise) => exercise && exercise.id
        ); // Filter valid exercises
        setExercises(validExercises);
      } catch (error) {
        setMessage("Eroare la √ÆncƒÉrcarea exerci»õiilor.");
      }
    };
    fetchExercises();
  }, []);

  const handleDelete = async (exerciseId) => {
    const confirmDelete = window.confirm("E»ôti sigur cƒÉ vrei sƒÉ »ôtergi acest exerci»õiu?");
    if (!confirmDelete) return;

    try {
      const response = await api.delete(`/reviewer/exercises/${exerciseId}`);
      if (response.data.status === "success") {
        setExercises((prev) => prev.filter((exercise) => exercise.id !== exerciseId));
        setMessage("Exerci»õiul a fost »ôters cu succes.");
      }
    } catch (error) {
      setMessage("Eroare la »ôtergerea exerci»õiului.");
    }
  };

  const handleAddExercise = async () => {
    try {
      const response = await api.post("/reviewer/exercises", newExercise);
      if (response.data.status === "success") {
        const validExercise = response.data.exercise;
        setExercises((prev) => [...prev, validExercise]);
        setMessage("Exerci»õiul a fost adƒÉugat cu succes.");
        setShowForm(false);
        setNewExercise({
          question: "",
          options: [],
          correct_option: null,
          correct_answer: "",
          type: "fill_blank",
          difficulty: "easy",
        });
      }
    } catch (error) {
      setMessage("Eroare la adƒÉugarea exerci»õiului.");
    }
  };

  const handleEditClick = (exercise) => {
    console.log("Exerci»õiul selectat pentru editare:", exercise); // Debug
    if (!exercise || !exercise.id) {
      setMessage("Eroare: Exerci»õiul selectat nu este valid.");
      return;
    }
    setEditingExercise({ ...exercise });
  };

  const handleEditExercise = async () => {
    try {
        const response = await api.put(`/reviewer/exercises/${editingExercise.id}`, editingExercise);
        if (response.data.status === "success") {
            setMessage("Exerci»õiul a fost actualizat cu succes."); // Display success message
            setEditingExercise(null); // Close the editing form

            // Refresh the page to reload all exercises
            window.location.reload();
        } else {
            setMessage("Eroare la actualizarea exerci»õiului."); // Handle unsuccessful update
        }
    } catch (error) {
        setMessage("Eroare la actualizarea exerci»õiului."); // Handle API errors
        console.error("Error updating exercise:", error); // Log error for debugging
    }
};


  const renderTypeSpecificFields = (exercise, setExercise) => {
    if (!exercise) return null;
    switch (exercise.type) {
      case "fill_blank":
      case "multiple_choice":
        return (
          <>
            <label>
              Op»õiuni (separate prin virgulƒÉ):
              <input
                type="text"
                value={exercise.options?.join(",") || ""}
                onChange={(e) =>
                  setExercise({
                    ...exercise,
                    options: e.target.value.split(","),
                  })
                }
                required
              />
            </label>
            <label>
              Op»õiunea corectƒÉ (index incepe cu 0):
              <input
                type="number"
                value={exercise.correct_option || ""}
                onChange={(e) =>
                  setExercise({
                    ...exercise,
                    correct_option: parseInt(e.target.value, 10),
                  })
                }
                required
              />
            </label>
          </>
        );
      case "rearrange":
        return (
          <label>
            RƒÉspuns corect:
            <input
              type="text"
              value={exercise.correct_answer || ""}
              onChange={(e) =>
                setExercise({
                  ...exercise,
                  correct_answer: e.target.value,
                  options: e.target.value.split(" ").sort(() => Math.random() - 0.5),
                })
              }
              required
            />
          </label>
        );
      default:
        return null;
    }
  };

  return (
    <div className="reviewer-page">
      <h2>Reviewer - Lista Exerci»õiilor</h2>
      {message && <p className="message">{message}</p>}
      <button className="add-button" onClick={() => setShowForm(true)}>
        ‚ûï AdaugƒÉ Exerci»õiu
      </button>
      {showForm && (
        <div className="form-container">
          <h3>AdaugƒÉ un Exerci»õiu</h3>
          <form
            onSubmit={(e) => {
              e.preventDefault();
              handleAddExercise();
            }}
          >
            <label>
              √éntrebare:
              <input
                type="text"
                value={newExercise.question}
                onChange={(e) =>
                  setNewExercise({ ...newExercise, question: e.target.value })
                }
                required
              />
            </label>
            <label>
              Dificultate:
              <select
                value={newExercise.difficulty}
                onChange={(e) =>
                  setNewExercise({ ...newExercise, difficulty: e.target.value })
                }
              >
                <option value="easy">U»ôor</option>
                <option value="medium">Mediu</option>
                <option value="hard">Greu</option>
              </select>
            </label>
            <label>
              Tip Exerci»õiu:
              <select
                value={newExercise.type}
                onChange={(e) =>
                  setNewExercise({ ...newExercise, type: e.target.value })
                }
              >
                <option value="fill_blank">Completare spa»õiu</option>
                <option value="multiple_choice">Alegere multiplƒÉ</option>
                <option value="rearrange">Rearanjare</option>
              </select>
            </label>
            {renderTypeSpecificFields(newExercise, setNewExercise)}
            <button type="submit" className="save-button">
              SalveazƒÉ
            </button>
            <button
              type="button"
              className="cancel-button"
              onClick={() => setShowForm(false)}
            >
              AnuleazƒÉ
            </button>
          </form>
        </div>
      )}
      <table className="exercise-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>√éntrebare</th>
            <th>Dificultate</th>
            <th>Tip</th>
            <th>Ac»õiuni</th>
          </tr>
        </thead>
        <tbody>
          {exercises
            .filter((exercise) => exercise && exercise.id) // Ensure valid objects
            .map((exercise) => (
              <tr key={exercise.id}>
                <td>{exercise.id}</td>
                <td>{exercise.question}</td>
                <td>{exercise.difficulty}</td>
                <td>{exercise.type}</td>
                <td>
                  <div className="buttons">
                    <button
                      className="delete-button"
                      onClick={() => handleDelete(exercise.id)}
                    >
                      üóëÔ∏è »òterge
                    </button>
                    <button
                      className="edit-button"
                      onClick={() => handleEditClick(exercise)}
                    >
                      ‚úèÔ∏è Editare
                    </button>
                  </div>
                </td>
              </tr>
            ))}
        </tbody>
      </table>
      {editingExercise && (
        <div className="form-container">
          <h3>Editare Exerci»õiu</h3>
          <form
            onSubmit={(e) => {
              e.preventDefault();
              handleEditExercise();
            }}
          >
            <label>
              √éntrebare:
              <input
                type="text"
                value={editingExercise.question || ""}
                onChange={(e) =>
                  setEditingExercise({
                    ...editingExercise,
                    question: e.target.value,
                  })
                }
                required
              />
            </label>
            <label>
              Dificultate:
              <select
                value={editingExercise.difficulty || "easy"}
                onChange={(e) =>
                  setEditingExercise({
                    ...editingExercise,
                    difficulty: e.target.value,
                  })
                }
              >
                <option value="easy">U»ôor</option>
                <option value="medium">Mediu</option>
                <option value="hard">Greu</option>
              </select>
            </label>
            <label>
              Tip Exerci»õiu:
              <select
                value={editingExercise.type || "fill_blank"}
                onChange={(e) =>
                  setEditingExercise({
                    ...editingExercise,
                    type: e.target.value,
                  })
                }
              >
                <option value="fill_blank">Completare spa»õiu</option>
                <option value="multiple_choice">Alegere multiplƒÉ</option>
                <option value="rearrange">Rearanjare</option>
              </select>
            </label>
            {renderTypeSpecificFields(editingExercise, setEditingExercise)}
            <button type="submit" className="save-button">
              SalveazƒÉ
            </button>
            <button
              type="button"
              className="cancel-button"
              onClick={() => setEditingExercise(null)}
            >
              AnuleazƒÉ
            </button>
          </form>
        </div>
      )}
    </div>
  );
}

export default Reviewer;